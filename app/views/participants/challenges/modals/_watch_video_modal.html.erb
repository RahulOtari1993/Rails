
<div class="modal fade text-left" id="watch_video_modal">
  <div class="modal-dialog">
    <div class="modal-content">

      <!-- Modal Header -->
      <div class="modal-header">
        <div class="row">
          <div class="col-12">
            <h4 class="modal-title"><%= challenge.name %></h4>
          </div>
        </div>
        <button type="button" class="close" data-dismiss="modal">&times;</button>
      </div>

      <!-- Modal body -->
      <div class="modal-body">
        <h4><b class="text-center"><%= challenge.title %></b></h4>
        <h6><%= challenge.description %></h6>
        <div class="row">
          <div class="col-12">
            <!-- <iframe id="player" src="https://www.youtube.com/embed/DjB1OvEYMhY?enablejsapi=1"></iframe> -->
            <div id="player"></div>
            <div class="progress">
              <div class="progress-bar bg-danger" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            <p class="pull-right" id="display"></p>
          </div>
        </div>
      </div>

      <!-- Modal footer -->
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">

    $(document).ready(function() {
      // create a element for watch a video start
      var tag = document.createElement('script');
      tag.src = "https://www.youtube.com/iframe_api";
      var firstScriptTag = document.getElementsByTagName('script')[0];
      firstScriptTag.parentNode.insertBefore(tag, firstScriptTag)
      // create a element for watch a video end
    })

    // Initialise the iframe  start
    var player, timer, timeSpent = [], completeWatchPercent, completeWatchStatus;
    var challengeId = <%= challenge.id %> ;

    function onYouTubeIframeAPIReady() {
      player = new YT.Player('player', {
        height: '260',
        width: '465',
        videoId: "<%= get_challenge_video_id(challenge) %>",
        events: {
          'onStateChange': onPlayerStateChange
        }
      });
    }
    // Initialise the iframe end


    // Iframe Events listeners and record watch video progress start
    function onPlayerStateChange(event) {
      if (event.data === 1) { // Started playing
        if (!timeSpent.length) {
         for (var i = 0, l = parseInt(player.getDuration()); i < l; i++) timeSpent.push(false);
        }
        timer = setInterval(record, 100);
      } else {
        clearInterval(timer);
      }
    }

    // record watch video progress start
    function record() {
      timeSpent[parseInt(player.getCurrentTime())] = true;
      if (completeWatchStatus == '' || completeWatchStatus == undefined) {
        completeWatchPercent = showPercentage();
        if (completeWatchPercent === 100) {
          completeWatchStatus = true
          submitChallenge(challengeId)
        }
      }
    }

    // Calculate and Show the percentage
    function showPercentage() {
      var percent = 0;
      for (var i = 0, l = timeSpent.length; i < l; i++) {
        if (timeSpent[i]) percent++;
      }
      percent = Math.round(percent / timeSpent.length * 100);

      $('#display').text(percent + "%");
      $( ".progress-bar" ).css("width", percent + "%");
      return percent;
    }
    // Iframe Events listeners and record watch video progress end

    // submit Challenge start
    function submitChallenge(challenge_id) {
      $.ajax({
        url: `/participants/challenges/${challengeId}/challenge_submission`,
        type: 'POST',
        dataType: 'JSON',
        data: { status: status },
        success: function(response) {
          if (response.status == 200) {
            alert("Success")
          } else {
            alert("Failed")
          }
        }
      });
    }
    // submit Challenge end

</script>

<style media="screen">
  .progress {
    height: 4px;
  }
  .text-center {
    text-align: center;
  }
</style>
